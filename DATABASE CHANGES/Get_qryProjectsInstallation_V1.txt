/****** Object:  StoredProcedure [dbo].[Get_qryProjectsInstallation_V1]    Script Date: 8/20/2025 2:42:33 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[Get_qryProjectsInstallation_V1]
    @JobID  Varchar(50) = NULL
AS
BEGIN
    SET NOCOUNT ON;
    
	SELECT MIN(PRODUCT.[name]) AS Product, tblProjects.JobID, CONCAT(tblPFiles.ProjectName, ', ' + tblPFiles.City, ', ' + tblStates.[State]) AS PName, MIN(tblProjects.ReleaseDate) AS ReleaseDate,
	MIN(tblProjects.ShipDate) AS ShipDate, MIN(tblProjects.InstallDate) AS InstallDate, MIN(qryInstallationBy.[Desc]) AS [Desc], 
	MIN(dbo.tblProjects.ShipToStreet + ',  ' + dbo.tblProjects.ShipToCity + ', ' + dbo.tblProjects.ShipToState + ', ' + dbo.tblProjects.ShipToCountry) AS ShipAddress, MIN(tblProjects.SiteContact) AS SiteContact,
	MIN(tblProjects.SiteContactTelephone) AS SiteContactTelephone, MIN(qryDealers.CompanyName) AS DCompanyName, MIN(dbo.qryDearlerAttention.[Name]) AS DealerContact,
	MIN(ISNULL(dbo.qryDealers.StreetAddress, '') + ' ' + ISNULL(dbo.qryDealers.City, '') + ' ' + ISNULL(dbo.qryDealers.State, '') + ' ' + ISNULL(dbo.qryDealers.ZipCode, '')) AS DealerAdd,
	MIN(dbo.qryDealers.Fax) AS DealerFax, MIN(dbo.qryDealers.Phone) AS DealerPhone, MIN(dbo.qryHobartListing.FirstName + ' ' + dbo.qryHobartListing.LastName) AS RepLName, MIN(HobartState.State) AS [State],
	MIN(dbo.qryHobartListing.Telephone) AS RepPhone, MIN(dbo.qryHobartListing.FaxNumber) AS RepFax,
	SUM(PROJECTS.Qty) AS Qty, (SELECT SUM(StockInHand) FROM Inv_Parts_StockInHand WHERE Inv_Parts_StockInHand.PartId = MIN(CHILD.id) GROUP BY Inv_Parts_StockInHand.PartId) AS CurrentStock,
	CONCAT(PARENT.PartNumber, ', ' + PARENT.PartDes) AS [ParentPartNumber], 
	CHILD.PartNumber AS CHILDPartNumber,
	CHILD.PartDes AS CHILDPartDes, MIN(qryAeroEmps_1.FirstName + ' ' + qryAeroEmps_1.LastName) AS ReviewBy, MIN(dbo.qryAeroEmps.FirstName + ' ' + dbo.qryAeroEmps.LastName) AS ProjectDesigner
	FROM Inv_AWProduct_Projects PROJECTS
	INNER JOIN Inv_AWProduct_Parts PARTS ON PARTS.id = PROJECTS.AWProductPartsID
	INNER JOIN Inv_AWProduct_Sub SUB ON SUB.id = PARTS.AWProductSubID
	LEFT JOIN Inv_AWProduct_Size ON Inv_AWProduct_Size.id = PARTS.SizeID
	LEFT JOIN Inv_Parts PARENT ON PARENT.id = PARTS.ParentPartID
	LEFT JOIN Inv_Parts CHILD ON CHILD.id = PARTS.ChildPartID
	LEFT JOIN Inv_AWProduct PRODUCT ON PRODUCT.id = SUB.AWProductID
	LEFT JOIN tblProjects ON tblProjects.JobID = PROJECTS.JobID
	LEFT JOIN tblPFiles ON tblPFiles.PNumber = tblProjects.ProposalID
	LEFT JOIN tblStates ON tblStates.StateID = tblPFiles.StateID
	LEFT OUTER JOIN dbo.qryInstallationBy ON dbo.tblProjects.InstallationBy = dbo.qryInstallationBy.InstallationByID 
	LEFT OUTER JOIN dbo.qryDealers ON tblPFiles.DealerID = qryDealers.DealerID 
	LEFT OUTER JOIN dbo.qryDearlerAttention ON dbo.tblProjects.JobID = dbo.qryDearlerAttention.JobID 
	LEFT OUTER JOIN dbo.qryHobartListing ON dbo.tblPFiles.RepID = dbo.qryHobartListing.RepID 
	LEFT OUTER JOIN dbo.tblStates AS HobartState ON dbo.qryHobartListing.StateID = HobartState.StateID 
	LEFT OUTER JOIN dbo.qryAeroEmps ON dbo.tblProjects.ProjectDesignerID = dbo.qryAeroEmps.EmployeeID
	LEFT JOIN  dbo.qryAeroEmps AS qryAeroEmps_1 ON qryAeroEmps_1.EmployeeID = dbo.tblProjects.ReviewedBy
	WHERE (dbo.tblPFiles.ProjectName IS NOT NULL) AND (dbo.tblProjects.JobID IS NOT NULL) AND (dbo.tblProjects.JobID = @JobID)
	GROUP BY
	tblProjects.JobID, CONCAT(tblPFiles.ProjectName, ', ' + tblPFiles.City, ', ' + tblStates.[State]), CONCAT(PARENT.PartNumber, ', ' + PARENT.PartDes),
	CHILD.PartNumber, CHILD.PartDes
	ORDER BY 
	tblProjects.JobID, CONCAT(tblPFiles.ProjectName, ', ' + tblPFiles.City, ', ' + tblStates.[State]), CONCAT(PARENT.PartNumber, ', ' + PARENT.PartDes),
	CHILD.PartNumber, CHILD.PartDes;
	
END
